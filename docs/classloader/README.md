## 클래스는 메모리에 로딩과 초기화가 언제될까

<b>클래스 로더(Class Loader)는 컴파일 된 자바의 클래스 파일(.class)을 동적으로 로드하고, JVM의 메모리 영역이 Runtime Data Area에 배치하는 작업을 수행한다</b>

클래스 로더에서 class 파일을 로딩하는 순서는 다음과 같이 3단계로 구성된다.

1. Loading(로드): 클래스 파일을 가져와서 JVM의 메모리에 로드한다
2. Linking(링크): 클래스 파일을 사용하기 위해 검증하는 과정이다
    + 검증: 바이트 코드가 자바 규칙의 맞게 작성되었는지 검증 단계
    + 준비: 클래스가 필요로하는 메모리를 미리 할당하는 단계
    + 분석: 클래스가 참조하는 객체의 메모리 주소값을 할당하는 단계
3. Initialization(초기화): 클래스 변수들을 적절한 값으로 초기화한다
    + static 변수의 값을 할당을 한 다음 클래스를 초기화하는 단계

유의할점은, 클래스를 메모리에 적재하는 Loading 기능은 한번에 메모리에 올리지 않고, 애플리케이션에서 필요한 경우 동적으로 메모리에 적재하게 된다

아래 링크에서 실제 코드를 이용해 호출 시점을 확인해볼 수 있다

<a href="https://inpa.tistory.com/entry/JAVA-%E2%98%95-%ED%81%B4%EB%9E%98%EC%8A%A4%EB%8A%94-%EC%96%B8%EC%A0%9C-%EB%A9%94%EB%AA%A8%EB%A6%AC%EC%97%90-%EB%A1%9C%EB%94%A9-%EC%B4%88%EA%B8%B0%ED%99%94-%EB%90%98%EB%8A%94%EA%B0%80-%E2%9D%93#%ED%81%B4%EB%9E%98%EC%8A%A4_%EC%B4%88%EA%B8%B0%ED%99%94_%EC%A7%84%ED%96%89_%EC%88%9C%EC%84%9C">
실제 코드를 이용한 호출 시점 확인</a>


---
<b>클래스 초기화는 오직 한번만 수행된다</b>

만약 멀티 쓰레드 환경에서 여러개의 쓰레드가 동시에 클래스를 인스턴스화 해도 클래스 초기화는 오직 한번만 수행된다.

정확히 말하자면 클래스 로딩이 최초 한번 초기화를 수행하고 그 이후에는 초기화를 스킵한다

이 의미는 멀티 쓰레드 환경에서 `클래스 초기화 동작 자체는 쓰레드 세이프`함을 의미한다

---
<b>클래스 로더(Class Loader)를 조금 더 들여다보면 3가지 단계의 탐색 과정을 거친다</b>

1. 로드 시도(Load Attempt): 클래스 로더는 해당 클래스의 이전 로딩 여부를 캐시에서 확인한다. 이미 로딩이되어 있는 경우 다시 로딩하지 않고 중복 로딩을 방지한다.
2. 부모 클래스 로더 호출(Delegate to Parent): 만약 클래스가 로드되어 있지 않다면, 현재 클래스 로더는 부모 클래스 로더에게 로딩을 위임한다. 부모 클래스 로더는 동일한 과정을 따라 클래스를 찾고
   로드를 시도한다.
3. 부모로부터 로딩이 실패한 경우 자신이 로딩(Load by Current Class Loader): 부모 클래스 로더로부터 해당 클래스를 찾을 수 없는 경우 현재 클래스 로더가 직접 로딩을 시도한다. 이 단계에서
   클래스 로더는 자신의 classpath를 통해 클래스를 찾아 로드한다

아래는 클래스 로더의 탐색 흐름과 종류를 보여준다

![](../../images/JVMClassLoader.png)

+ 부트스트랩 클래스 로더(Bootstrap Class Loader)
    + JVM 시작 시 가장 최초로 실행되는 클래스로더이다. 자바 클래스의 기본적인 클래스(java.lang.Object, Class, Classloader)만을 로드한다.
    + Java 8 기준으로 `${JAVA_HOME}/jre/lib`에 위치한 클래스를 로드한다.
+ 확장 클래스 로더(Extension Class Loader)
    + 부트스트랩 클래스 로더를 부모로 갖는 클래스 로더로써, 확장 자바 클래스들을 로드한다.
    + `java.ext.dirs` 환경 변수에 설정된 디렉토리의 클래스 파일들을 로드하고, 이 값이 설정 되어 있지 않은 경우 `${JAVA_HOME}/jre/lib/ext`에 있는 클래스 파일을 로드한다.
+ 애플리케이션 클래스 로더(Application Class Loader)
    + 자바 프로그램 실행 시 지정한 `classpath`에 있는 클래스 파일 또는 `Jar`에 속한 클래스들을 로드한다.


